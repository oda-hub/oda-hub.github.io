<!DOCTYPE html>
<html lang="en-us" dir="ltr">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="description" content="MMODA workflow development Guide #  The MMODA platform provides access to the Astronomical Open Research Data Analysis Services (ORDAS). Good fraction of these services follow a simple scheme, they:
 access publicly available external astronomical data archives to fetch data relevant to specific source or source catalog, transform the fetched data using a workflow based on a Python notebook to derive a data product. display a preview of the data product on the MMODA frontend and/or return the data product to the user via Python API  The users of MMODA are encouraged to become its developers and add new ORDAS.">
<meta name="theme-color" content="#FFFFFF">
<meta name="color-scheme" content="light dark"><meta property="og:title" content="" />
<meta property="og:description" content="MMODA workflow development Guide #  The MMODA platform provides access to the Astronomical Open Research Data Analysis Services (ORDAS). Good fraction of these services follow a simple scheme, they:
 access publicly available external astronomical data archives to fetch data relevant to specific source or source catalog, transform the fetched data using a workflow based on a Python notebook to derive a data product. display a preview of the data product on the MMODA frontend and/or return the data product to the user via Python API  The users of MMODA are encouraged to become its developers and add new ORDAS." />
<meta property="og:type" content="article" />
<meta property="og:url" content="https://odahub.io/docs/guide-development/" /><meta property="article:section" content="docs" />



<title>Guide Development | About ODA</title>
<link rel="manifest" href="../../manifest.json">
<link rel="icon" href="../../favicon.png" type="image/x-icon">
<link rel="stylesheet" href="../../book.min.c58292d36b18b675680ab9baea2029204537b839ea72f258746ec0f32ce8d6c8.css" integrity="sha256-xYKS02sYtnVoCrm66iApIEU3uDnqcvJYdG7A8yzo1sg=" crossorigin="anonymous">
  <script defer src="../../flexsearch.min.js"></script>
  <script defer src="../../en.search.min.b713972c7823b4088f41999f0a9951c537b4a8966086f71499ceb4b70667738f.js" integrity="sha256-txOXLHgjtAiPQZmfCplRxTe0qJZghvcUmc60twZnc48=" crossorigin="anonymous"></script>
<!--
Made with Book Theme
https://github.com/alex-shpak/hugo-book
-->
  <script src="https://hypothes.is/embed.js" async></script>
</head>
<body dir="ltr">
  <input type="checkbox" class="hidden toggle" id="menu-control" />
  <input type="checkbox" class="hidden toggle" id="toc-control" />
  <main class="container flex">
    <aside class="book-menu">
      <div class="book-menu-content">
        
  <nav>
<h2 class="book-brand">
  <a class="flex align-center" href="../../"><span>About ODA</span>
  </a>
</h2>


<div class="book-search">
  <input type="text" id="book-search-input" placeholder="Search" aria-label="Search" maxlength="64" data-hotkeys="s/" />
  <div class="book-search-spinner hidden"></div>
  <ul id="book-search-results"></ul>
</div>












  



  
  <ul>
    
      
        <li>
          
  
  

  
    <a href="../../docs/guide-development/" class="active">Guide Development</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../docs/guide-discovery/" class="">Guide Discovery</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../docs/guide-ontology/" class="">Guide Ontology</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../docs/issues/" class="">Issues</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../docs/reasoning-engine/" class="">Reasoning Engine</a>
  

        </li>
      
    
      
        <li>
          
  
  

  
    <a href="../../docs/workflow-development-progression/" class="">Workflow Development Progression</a>
  

        </li>
      
    
  </ul>















</nav>




  <script>(function(){var a=document.querySelector("aside .book-menu-content");addEventListener("beforeunload",function(b){localStorage.setItem("menu.scrollTop",a.scrollTop)}),a.scrollTop=localStorage.getItem("menu.scrollTop")})()</script>


 
      </div>
    </aside>

    <div class="book-page">
      <header class="book-header">
        
  <div class="flex align-center justify-between">
  <label for="menu-control">
    <img src="../../svg/menu.svg" class="book-icon" alt="Menu" />
  </label>

  <strong>Guide Development</strong>

  <label for="toc-control">
    
    <img src="../../svg/toc.svg" class="book-icon" alt="Table of Contents" />
    
  </label>
</div>


  
  <aside class="hidden clearfix">
    
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#build-a-repeatable-parameterized-workflow">Build a repeatable parameterized workflow</a>
      <ul>
        <li><a href="#how-to-designate-input-parameters-and-output-cells-of-the-notebook">How to designate input parameters and output cells of the notebook</a></li>
        <li><a href="#how-to-define-input-parameters-in-the-dedicated-parameters-cell">How to define input parameters in the dedicated parameters cell</a></li>
        <li><a href="#default-parameters">Default parameters</a></li>
        <li><a href="#adding-annotations-the-entire-notebook">Adding annotations the entire notebook</a></li>
        <li><a href="#adding-external-resource-annotations">Adding external resource annotations</a></li>
        <li><a href="#adding-token-annotations">Adding token annotations</a></li>
        <li><a href="#how-to-annotate-the-notebook-outputs">How to annotate the notebook outputs</a></li>
        <li><a href="#quering-external-astronomical-data-archives-from-a-notebook">Quering external astronomical data archives from a notebook</a></li>
        <li><a href="#handling-exceptions">Handling exceptions</a></li>
        <li><a href="#how-to-add-a-test-to-the-notebook">How to add a test to the notebook</a></li>
        <li><a href="#reporting-progress-for-long-running-tasks">Reporting progress for long running tasks</a></li>
      </ul>
    </li>
    <li><a href="#make-the-notebook-available-for-deployment-on-mmodahttpswwwastrounigechmmoda-via-renkulabiohttpsrenkulabio">Make the notebook available for deployment on <a href="https://www.astro.unige.ch/mmoda/">MMODA</a> via <a href="https://renkulab.io/">renkulab.io</a></a></li>
    <li><a href="#publish-your-workflow-as-an-mmoda-service">Publish your workflow as an <strong>MMODA</strong> service</a>
      <ul>
        <li><a href="#support-the-workflow-development-via-renku-plugin">Support the workflow development via renku plugin</a></li>
        <li><a href="#inform-mmoda-team-and-suggest-automatic-test-cases-to-ensure-service-stability">Inform <strong>MMODA</strong> team and suggest automatic test cases to ensure service stability</a></li>
      </ul>
    </li>
  </ul>
</nav>



  </aside>
  
 
      </header>

      
      
  <article class="markdown"><h1 id="mmodahttpswwwastrounigechmmoda-workflow-development-guide">
  <a href="https://www.astro.unige.ch/mmoda">MMODA</a> workflow development Guide
  <a class="anchor" href="#mmodahttpswwwastrounigechmmoda-workflow-development-guide">#</a>
</h1>
<p>The <a href="https://www.astro.unige.ch/mmoda">MMODA</a> platform provides access to the Astronomical Open Research Data Analysis Services (ORDAS). Good fraction of these services follow a simple scheme, they:</p>
<ul>
<li>access publicly available external astronomical data archives to fetch data relevant to specific source or source catalog,</li>
<li>transform the fetched data using a workflow based on a Python notebook to derive a data product.</li>
<li>display a preview of the data product on the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend and/or return the data product to the user via  Python <a href="https://github.com/oda-hub/oda_api">API</a></li>
</ul>
<p>The users of <a href="https://www.astro.unige.ch/mmoda">MMODA</a> are encouraged to become its developers and add new ORDAS. This help page provides a step-by step instructions on how to add new services to <a href="https://www.astro.unige.ch/mmoda">MMODA</a> .</p>
<p>Workflows are all things that can be computed, broadly speaking. For reproducibility, we want our workflows to be repeatable: producing the same output every time they are computed. This looks easy enough in first approximation, but might be harder to achieve than it seems when the workflow relies on external data and compute resources  and has to yield an &ldquo;up-and-running&rdquo; ORDAS in an ever-evolving compute environment. This help page is also aimed at helping the developers in ensuring reproducibility and reusability of their workflows converted to ORDAS.</p>
<h2 id="build-a-repeatable-parameterized-workflow">
  Build a repeatable parameterized workflow
  <a class="anchor" href="#build-a-repeatable-parameterized-workflow">#</a>
</h2>
<p>Suppose you have a <a href="https://renkulab.io/projects/astronomy/mmoda/fermi/files/blob/Lightcurve.ipynb"><strong>jupyter notebook</strong></a> that derives some useful information (a lightcurve in the GeV gamma-ray band) on an astronomical source  from data found in an astronomical data archive (in our example, it will be <a href="https://fermi.gsfc.nasa.gov/ssc/data/access/">Fermi LAT data archive</a>).</p>
<p>The first essential step in promoting the notebook to an ORDAS is to make the workflow of the notebook <strong>reusable</strong> by parameterizing it. For example, it is initeresting to enable generation of similar data products for different sources, by simply giving the source name or coordinates as <strong>input parameters</strong> to the workflow. It is also useful to explicitly tag the resulting data product (the lightcurve in our example) as the <strong>output</strong>, to make clear which of the numerous entities generated by the notebook is the final result. It is also possible to convert non-parametrized but strickly repeatable notebooks to services (for example, to assure reproducibility of a result published in a research publication), but this is less interesting since they always produce the same output data products.</p>
<h3 id="how-to-designate-input-parameters-and-output-cells-of-the-notebook">
  How to designate input parameters and output cells of the notebook
  <a class="anchor" href="#how-to-designate-input-parameters-and-output-cells-of-the-notebook">#</a>
</h3>
<p>In <a href="https://www.astro.unige.ch/mmoda">MMODA</a> we use the approach of <a href="https://papermill.readthedocs.io/en/latest/usage-parameterize.html#designate-parameters-for-a-cell">papermill</a>) to <strong>tag</strong> the notebook cells that contain the input parameters and the outputs. In your notebook, you may create two dedicated cells with the &ldquo;parameters&rdquo; and &ldquo;outputs&rdquo; tags. In the Jupyter Lab environment this can be done by clicking on the cogwheel sign on the right top, red arrow in the image below, and adding new tag as pointed by the second red arrow:
<img src="tmp1.png" alt="image" /></p>
<h3 id="how-to-define-input-parameters-in-the-dedicated-parameters-cell">
  How to define input parameters in the dedicated parameters cell
  <a class="anchor" href="#how-to-define-input-parameters-in-the-dedicated-parameters-cell">#</a>
</h3>
<p>The variables defined in the dedicated &ldquo;parameters&rdquo; cell, will be the input parameters of the workflow. They will be visualized in the frontend of the service and it will be possible to provide these parameters via the service <a href="https://github.com/oda-hub/oda_api">API</a>. For example, in the image of the parameters cell in our example (see above)</p>
<ul>
<li>the names of the declared variables will be used as parameter names in the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> service (except the <strong>default</strong> parameters, see below). For example, the <code>Source_region_radius</code> variable will be visible in the frontend as a query parameter with the same name. It will appear with a default value assigned to it (<code>2.</code> in the example notebook).</li>
<li>if not annotated, the types of the inputs parameters are determined based on the parameter default value (would be <code>float</code> for the <code>Source_region_radius</code> parameter).</li>
<li>otherwise, it is possible to customize the parameter by adding annotation the input parameter with an MMODA <a href="https://odahub.io/docs/guide-ontology">ontology</a> item as a comment (after the hash sign, <code>#http://odahub.io/ontology#AngleDegrees</code> in the reference example of the <code>Source_region_radius</code> parameter. This may be useful for checking the validity of the user inputs. For example, the sky angle in degrees (defined by the <code>#http://odahub.io/ontology#AngleDegrees</code>) should be a float number and can take values between 0 and 360.</li>
<li>it also possible to directly express additional restrictions on the parameter value by using annotation properties <code>oda:lower_limit</code>, <code>oda:upper_limit</code>, <code>oda:allowed_value</code>. For example, to define an angle with maximum value of 10deg, the annotation will be <code># oda:AngleDegrees; oda:upper_limit 10.</code> Another example is a string parameter with possible values of &ldquo;b&rdquo;, &ldquo;g&rdquo;, &ldquo;r&rdquo;: <code>oda:String; oda:allowed_value 'b','g','r'.</code></li>
<li>to explicitly express units of the parameter, one can use predefined <code>oda:ExpressedInUnit</code> subclasses, like <code># oda:Float; oda:GeV</code> or annotation property, like <code># oda:Float; oda:unit unit:GeV</code>.</li>
</ul>
<h3 id="default-parameters">
  Default parameters
  <a class="anchor" href="#default-parameters">#</a>
</h3>
<p>Several <strong>default</strong> common parameters are always set by the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend. These include:</p>
<table>
<thead>
<tr>
<th>Type annotation</th>
<th>Parameter default name</th>
</tr>
</thead>
<tbody>
<tr>
<td><a href="http://odahub.io/ontology#PointOfInterestRA">http://odahub.io/ontology#PointOfInterestRA</a></td>
<td>RA</td>
</tr>
<tr>
<td><a href="http://odahub.io/ontology#PointOfInterestDEC">http://odahub.io/ontology#PointOfInterestDEC</a></td>
<td>DEC</td>
</tr>
<tr>
<td><a href="http://odahub.io/ontology#StartTime">http://odahub.io/ontology#StartTime</a></td>
<td>T1</td>
</tr>
<tr>
<td><a href="http://odahub.io/ontology#EndTime">http://odahub.io/ontology#EndTime</a></td>
<td>T2</td>
</tr>
<tr>
<td><a href="http://odahub.io/ontology#AstrophysicalObject">http://odahub.io/ontology#AstrophysicalObject</a></td>
<td>src_name</td>
</tr>
</tbody>
</table>
<p>The default parameters are common to all workflows in the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> ecosystem. They appear at the top of the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend as shown below:</p>
<p><img src="tmp2.png" alt="image" /></p>
<p>If the notebook contains parameters anotated with these types, their names will be automatically considered as the parameters appearing in the common parameter field of all services. If some of them are ommited, they will be added to the list of workflow parameters automatically.</p>
<p>Note that both <strong>source name</strong> and  <strong>source coordinates</strong> are passed to the workflow, and in principle there is no guarantee the coordinates are that of the source. We leave it up to the workflow developer to reconcile these parameters. Please explain the logic in the associated help page of the service.</p>
<h3 id="adding-annotations-the-entire-notebook">
  Adding annotations the entire notebook
  <a class="anchor" href="#adding-annotations-the-entire-notebook">#</a>
</h3>
<p>Annotations can apply to parameters or entire notebook. In both cases they are kept in the notebook cell tagged <code>parameters</code>.
For example:</p>
<pre tabindex="0"><code># oda:version &quot;v0.1.1&quot;
# oda:reference &quot;https://doi.org/10.1051/0004-6361/202037850&quot;

source_name = &quot;Crab&quot; # oda:AstrophysicalObject
reference_energy = 20 # oda:keV
</code></pre><h3 id="adding-external-resource-annotations">
  Adding external resource annotations
  <a class="anchor" href="#adding-external-resource-annotations">#</a>
</h3>
<p>In case your notebook explicitly calls some external resources, such as S3 storage or compute cluster this should be reflected in the annotations in the notebook cell tagged <code>parameters</code>. Below is the list of the resource annotations supported currently:</p>
<p><code>oda:S3</code> - S3 storage<!-- raw HTML omitted -->
<code>oda:Dask</code> - Dask compute cluster<!-- raw HTML omitted --></p>
<p>All kinds of resources may have <code>resourceBindingEnvVarName</code> property. If the resource is available the corresponding enviroment variable stores json with the credentials needed to access the resource.</p>
<p>For example, in the code below we declare the S3 storage:</p>
<pre tabindex="0"><code># oda:usesRequiredResource oda:MyS3 .
# oda: MyS3 a oda:S3 .
# oda: MyS3 oda:resourceBindingEnvVarName &quot;MY_S3_CREDENTIALS&quot; .
</code></pre><p>In the code below we initialize the S3 storage session using the credentials provided by means of the environment variable:</p>
<pre tabindex="0"><code>import json
import os
from minio import Minio

credentials_env = os.environ.get('MY_S3_CREDENTIALS')
if credentials_env:
	credentials=json.loads(credentials_env)
	client = Minio(
            endpoint=credentials[&quot;endpoint&quot;],
            access_key=credentials[&quot;access_key&quot;],
            secret_key=credentials[&quot;secret_key&quot;],
        )

</code></pre><p>In the example below we declare dask cluster resource requirements in the parameter cell</p>
<pre tabindex="0"><code># oda:usesRequiredResource oda:MyDaskCluster .
# oda: MyDaskCluster a oda:Dask .
# oda: MyDaskCluster oda:memory_per_process &quot;2G&quot; .
# oda: MyDaskCluster oda:n_processes &quot;16&quot; .
# oda: MyDaskCluster oda:resourceBindingEnvVarName &quot;MY_DASK_CREDENTIALS&quot; .
</code></pre><p>Here <code>memory_per_process</code> and <code>n_processes</code> define minimal requirements to the resource.</p>
<p>In the code below we open the dask cluster session</p>
<pre tabindex="0"><code>import json
from dask.distributed import Client

credentials_env = os.environ.get('MY_DASK_CREDENTIALS')
if credentials_env:
	credentials=json.loads(credentials_env)
	client = Client(address=credentials[&quot;address&quot;])

</code></pre><h3 id="adding-token-annotations">
  Adding token annotations
  <a class="anchor" href="#adding-token-annotations">#</a>
</h3>
<p>In case your notebook uses token to access some resources this should be reflected in the annotations in the notebook cell tagged <code>parameters</code> in the following way:</p>
<pre tabindex="0"><code># oda:oda_token_access oda:InOdaContext .
</code></pre><p>The above expression enables the standard mechanism to supply token using oda context variable. Then the token can be accessed from the code in the following way:</p>
<pre tabindex="0"><code>from oda_api.api import get_context
token = get_context()['token']
</code></pre><p>However, we recommend instead using higer level  <code>oda_api.token</code> API, which also provides token validation and token discovery method as options. The code above is eqivalent to the following higher level code</p>
<pre tabindex="0"><code>from oda_api.token import discover_token, TokenLocation
token = discover_token(allow_invalid=True, token_discovery_methods=[TokenLocation.CONTEXT_FILE])
</code></pre><p>Below is the entire list of token locations supported:</p>
<pre tabindex="0"><code>class TokenLocation(Enum):
    ODA_ENV_VAR = &quot;environment variable ODA_TOKEN&quot;
    FILE_CUR_DIR = &quot;.oda-token file in current directory&quot;
    FILE_HOME = &quot;.oda-token file in home&quot;
    CONTEXT_FILE = &quot;context file current directory&quot;
</code></pre><p>By default, token validation is enabled and the attempts are made to load the token from all the supported locations in the order they appear in the TokenLocation class.</p>
<h3 id="how-to-annotate-the-notebook-outputs">
  How to annotate the notebook outputs
  <a class="anchor" href="#how-to-annotate-the-notebook-outputs">#</a>
</h3>
<p>A cell tagged &ldquo;outputs&rdquo; defines the data product(s) that will be provided by the service:</p>
<p><img src="tmp3.png" alt="image" /></p>
<p>The outputs may be strings, floats, lists, numpy arrays, astropy tables etc. They may be also strings which contain filenames for valid files. If they do, the whole file will be considered as the output.  Similar to the &ldquo;parameters&rdquo; cell, the &ldquo;outputs&rdquo; cell should contain the definitions of the output variables followed by equality that assigns values to them and a comment that defines their type (for example, the variable <code>lightcurve_astropy_table</code> in the example shown above takes the value <code>lightcurve</code> which is an astropy table. the comment field <code># http://odahub.io/ontology#ODAAstropyTable</code> specifies this in terms of the MMODA <a href="https://odahub.io/ontology/">ontology</a>. If you want to give more detailed description of the notebook input and output, use <code>terms</code> from the pre-defined ontology described  <a href="[docs/guide-ontology.]%28https://odahub.io/docs/guide-ontology%29">here</a>.</p>
<p>There is also one special type of the output annotation <code># http://odahub.io/ontology#WorkflowResultComment</code>. An output variable of string type, annotated with it will be returned as a comment, shown in yellow field upon completion of the job.</p>
<h3 id="quering-external-astronomical-data-archives-from-a-notebook">
  Quering external astronomical data archives from a notebook
  <a class="anchor" href="#quering-external-astronomical-data-archives-from-a-notebook">#</a>
</h3>
<p>It is very likely that your analysis workflow needs to access astronomical data retrievable from an external archive. A good practice is to avoid placing  large volumes of data direcly into the container where the analysis notebook runs (this would overload the <a href="https://renkulab.io">renkulab.io</a> platform which we use for new service deployment).  A better approach is to query the relevant data using online services, for example, <a href="https://www.ivoa.net/documents/TAP/">Table Access Protocol (TAP)</a> services, or services available through the <a href="https://astroquery.readthedocs.io/en/latest/index.html">astroquery</a> Python module. In our example case of Fermi/LAT analysis, we use the <a href="https://astroquery.readthedocs.io/en/latest/fermi/fermi.html">astroquery.fermi</a> module to query the archive of publicly available Fermi/LAT data from <a href="https://fermi.gsfc.nasa.gov/ssc/">Fermi Science Support Center</a> in the Cell 4 of the notebook <a href="https://renkulab.io/projects/astronomy/mmoda/fermi/files/blob/Lightcurve.ipynb">Lightcurve.ipynb</a>.</p>
<p>Of course, relying on external data archives and data access services may pose a problem for reproducibility of results and potentially for the service operational stability. The external services may have downtime period, they may be upgraded and change their API etc. We leave it to the developer to make sure the requests to external services are operational and reproducible. We encourage the developers to supply tests (see <a href="https://odahub.io/docs/guide-development/#how-to-add-a-test-to-the-notebook">guide</a>) that will be automatically executed from time to time during service operations and are supposed to always yield exactly the same results. If this is not so, this may signal a problem with non-availability of some external services, in this cases you, as the service developer, will be alerted and invited to investigate the origin of the problem.  It may also happen that the notebook would not produce the exactly
the same result every time but still be reproducible (see motivation on <a href="https://github.com/volodymyrss/reproducibility-motivation/">the difference between reproducibility and repeatability</a>).</p>
<h3 id="handling-exceptions">
  Handling exceptions
  <a class="anchor" href="#handling-exceptions">#</a>
</h3>
<p>It can happen that your analysis workflow is expected to produce no data products in some cases, for example, if there is no data for a specified source and time interval, if the parameters specified by the user have wrong format, or in other &ldquo;exceptions&rdquo;  In this case, it would be good to inform the user what happened. This can be done using the raise <code>RuntimeError()</code> method directly in the notebook, as shown below:</p>
<p><img src="tmp21.png" alt="image" /></p>
<p>Don&rsquo;t worry if you do not succeed to foresee all possible exceptions at the initial development stage. If unforeseen exceptions would occur when the service is already deployed and available to users, each time an unforeseen exception occurs, you will be notified and invited to patch your notebook to handle this exception (perhaps raising a new <code>RuntimeError()</code> case in the appropriate cell).</p>
<h3 id="how-to-add-a-test-to-the-notebook">
  How to add a test to the notebook
  <a class="anchor" href="#how-to-add-a-test-to-the-notebook">#</a>
</h3>
<p>It is a good practice to test the developed notebook. This allows to make sure that the code remains valid in the future.
A test is implemented as another notebook, except that name of the notebook starts with &ldquo;test_&rdquo;. The notebook should call other notebooks and check that the output matches expectations. See an example of such a test <a href="https://gitlab.renkulab.io/astronomy/mmoda/mmoda-nb2workflow-example/-/blob/master/notebooks/test_lightcurve.ipynb">here</a>.</p>
<h3 id="reporting-progress-for-long-running-tasks">
  Reporting progress for long running tasks
  <a class="anchor" href="#reporting-progress-for-long-running-tasks">#</a>
</h3>
<p>In case your computation task runs considerable amount of time and can be split into stages
consider reporting task progress using ODA API class ProgressReporter:</p>
<pre tabindex="0"><code>from oda_api.api import ProgressReporter
pr = ProgressReporter()
pr.report_progress(stage='simulation', progress=0, substage='step 1')
# implement step 1
pr.report_progress(stage='simulation', progress=50, substage='step 2')
# implement step 2
</code></pre>Make the notebook available for deployment on <a href="https://www.astro.unige.ch/mmoda/">MMODA</a> via <h2 id="make-the-notebook-available-for-deployment-on-mmodahttpswwwastrounigechmmoda-via-renkulabiohttpsrenkulabio">
  <a href="https://renkulab.io/">renkulab.io</a>
  <a class="anchor" href="#make-the-notebook-available-for-deployment-on-mmodahttpswwwastrounigechmmoda-via-renkulabiohttpsrenkulabio">#</a>
</h2>
<p>The parameterized workflow formulated as a Python notebook can be converted into a service provided by <a href="https://www.astro.unige.ch/mmoda/">MMODA</a>  by a bot that scans a specific location <code>astronomy/mmoda</code> in the project directory on the  <a href="https://renkulab.io/">renkulab.io</a> collaborative platform. Creating a new project in this directory will make it visible for the bot. In our example of Fermi/LAT lightcurve workflow, it is in the <a href="https://renkulab.io/projects/astronomy/mmoda/fermi">fermi</a> subdirectory of <code>astronomy/mmoda</code>.</p>
<p>To proceed along this way, you first you need to make sure your notebook runs correctly in the  <a href="https://renkulab.io/">renkulab.io</a> environment. You can start a new project in the <code>astronomy/mmoda</code> by clicking on the &ldquo;Creat new project&rdquo; button.</p>
<p><img src="tmp4.png" alt="image" /></p>
<p>You will need to choose the name of the new project. This name will be the name of your service appearing at the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend and discoverable via <a href="https://www.astro.unige.ch/mmoda">MMODA</a> API. Place your project in the <code>astronomy/mmoda</code> namespace by specifying this in the &ldquo;Namespace&rdquo; field as shown below:</p>
<p><img src="tmp5.png" alt="image" /></p>
<p>Choose the &ldquo;Python 3&rdquo; template for the project and then click &ldquo;Create project&rdquo; button:</p>
<p><img src="tmp6.png" alt="image" /></p>
<p>To start working on the newly created project, you can launch an interactive Jupyter lab session by clicking on the &ldquo;Start&rdquo; button:</p>
<p><img src="tmp7.png" alt="image" /></p>
<p>Once in the Jupyter lab environment, you can update the project by uploading the notebook that you intend to promote to a service:</p>
<p><img src="tmp8.png" alt="image" /></p>
<p>Your notebook most probably imports some python packages that are not installed by default in a generic Python environment on <a href="https://renkulab.io">renkulab.io</a>. To add necessary packages, you need to update the <code>requirements.txt</code> and possibly <code>environment.yml</code> files with the packages you need:</p>
<p><img src="tmp9_1.png" alt="image" /></p>
<p>In the example of Fermi/LAT analysis we are considering, packages <code>astropy</code>, <code>matplotlib</code> and <code>astroquery</code> packages will be needed. They can be added in the requirements.txt file as shown above.</p>
<p>Once you are done with uploading your notebook and adding missing Python packages into the requirements.txt file, you can commit changes to your project by going to the GitLab tab in the Jupyter lab interface. You will see files that have been added or modified appearing as such in the dedicated sub-panel as shown below:</p>
<p><img src="tmp10_2.png" alt="image" /></p>
<p>Promote these files to the &ldquo;Staged&rdquo; state by clicking at the &ldquo;+&rdquo; signs next to them and commit changes to your project by clicking at the &ldquo;Commit&rdquo; buttong just below the file list. Next, push the comitted changes to the Gitlab by pressing the &ldquo;push&rdquo; button (see the screenshot above).</p>
<p>Now the CI/CD of the Gitlab will generate a new container in which all necessary Python packages and the notebook to be promoted to a service will be available. This may take a few minutes. You can test this new container in operation if you start a new interactive session on renkulab.io, using the container produced from your latest commit.</p>
<p>If the notebook runs as expected and produces correct outputs, you may proceed to the next stage and deploy a new service.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h2 id="publish-your-workflow-as-an-mmoda-service">
  Publish your workflow as an <strong>MMODA</strong> service
  <a class="anchor" href="#publish-your-workflow-as-an-mmoda-service">#</a>
</h2>
<p>If you project is in the <code>/astronomy/mmoda/</code> namespace, it is straightforward to convert it into a <a href="https://www.astro.unige.ch/mmoda">MMODA</a> service. All you need to do is to add a <code>live-workflow</code> as a topic at the project Gitlab that you can access by clicking on the &ldquo;GitLab&rdquo; button at  the main project page on renkulab.io:</p>
<p><img src="tmp11.png" alt="image" /></p>
<p>At the GitLab webpage, go to the &ldquo;Settings&rdquo; section, the &ldquo;Topic&rdquo; field is in the &ldquo;General&rdquo; settings:</p>
<p><img src="tmp12.png" alt="image" /></p>
<p>Note that you may add multiple topics in this field. In the example of Fermi/LAT shown above, there is an additional topic &ldquo;MM Gamma-rays&rdquo; that helps <a href="https://www.astro.unige.ch/mmoda">MMODA</a> users to classify workflows by the messenger and waveband types. Any topic which starts with &ldquo;MM &quot; (note the space) will be shown as a messenger label in MMODA, excluding the &ldquo;MM &quot; prefix. The additional topic will appear in the name of the tab of your workflow on <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend. The topics associated to your project are visible right below the project name on the Gitlab pages:</p>
<p><img src="tmp13.png" alt="image" /></p>
<p>Once the project is associated to the <code>live-workflow</code> topic, it becomes visible to a bot that periodically scans the Gitlabs of the projects in the <code>astronomy/mmoda</code> domain, looking for new or modified &ldquo;live&rdquo; workflows that propose themselves as online services for MMODA. The bot will try to convert your notebook into a service and if this works, it will automatically add the new service  <a href="https://www.astro.unige.ch/mmoda">MMODA</a> (by default, on to its staging instance). You can monitor the progress of the bot work if you visit the &ldquo;COntinuous Integration / Continuous Development&rdquo; (CI/CD) section of the GitLab page of your project. It will show that a pipeline is in progress, both on the build of the updated renkulab project container image and on the &ldquo;External&rdquo; MMODA side:</p>
<p><img src="tmp20.png" alt="image" /></p>
<p>Once the deployment is finished, you will recieve an email similar to this:</p>
<p><img src="tmp14.png" alt="image" /></p>
<p>You may now connect to the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend to test the functionalities of your service, check the correctness of appearance and format of the input parameters that you have specified in the <code>parameters</code> cell of the notebook, check the formatting and correctness of the data products that are produced upon pressing the &ldquo;Submit&rdquo; button on the frontend etc:</p>
<p><img src="tmp15_1.png" alt="image" /></p>
<p>Note that some of the input parameters in the example of the Fermi/LAT <a href="https://renkulab.io/projects/astronomy/mmoda/fermi/files/blob/Lightcurve.ipynb">Lightcurve.ipynb</a> notebook appear as multiple choice parameters with pre-defined values, while others are query fields. For some of the parameters, units are specified just below the query window. The names of the parameters are the names of the variables defined in the <code>parameters</code> cell of the notebook (see the screenshot of the parameters cell in the <a href="#build-a-repeatable-parameterized-workflow">section above</a> of this help page. Have a look in the example how this is regulated with parameter annotations.</p>
<p>If the <code>outputs</code> cell of your notebook contains multiple data products, they will be shown as a list at the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> frontend, as shown above. The names of the list items correspond to the names of the variables defined in the <code>outputs</code> cell. Each item of the list can be previewed or downloaded by clicking on the &ldquo;View&rdquo; button. The preview will depend on the type of the data product that has been specified after the comment  hash <code>#</code> tag in the <code>outputs</code> cell.</p>
<p>You can explore different examples of the notebooks converted to services in the <code>astronomy/mmoda</code> domain on renkulab.io, to see how to format the inputs and outputs. If unsure, first take a look on <a href="https://renkulab.io/projects/astronomy/mmoda/mmoda-nb2workflow-example">this simple repository</a>. You can also experiment with further possibilities exploring the <a href="https://odahub.io/ontology/">ontology</a> of the <a href="https://www.astro.unige.ch/mmoda">MMODA</a> parameters and data products.</p>
<p>By default, all notebooks residing in the root of the repository (except the ones named as <code>test_*.ipynb</code>) will be converted to separate data-products. If notebooks are in the subdirectory, one needs to add the configuration file <code>mmoda.yaml</code> with
<code>notebook_path: &quot;subfolder/path&quot;</code>. It&rsquo;s also possible to include only some notebooks by putting into <code>mmoda.yaml</code> e.g. <code>filename_pattern: &quot;prefix_.*&quot;</code> to define the notebook name regex pattern.</p>
<p>To add a help for the workflow one have to create a file <code>mmoda_help_page.md</code> in the root of the repository. This file will be converted by the bot to the help page, associated with the corresponding instrument tab in the MMODA platform interface.</p>
<p><img src="fermi-help-button.png" alt="Help button screenshot" />
<img src="fermi-help-page.png" alt="Help page screenshot" /></p>
<p>The file <code>aknowledgemets.md</code> is used to edit the acknowledgements text, which is shown at the bottom of the products window. The default text refers to the renku repository, in which the workflow was created.</p>
<!-- raw HTML omitted -->
<!-- raw HTML omitted -->
<h3 id="support-the-workflow-development-via-renku-plugin">
  Support the workflow development via renku plugin
  <a class="anchor" href="#support-the-workflow-development-via-renku-plugin">#</a>
</h3>
<p>To support the development of workflows in Renku, a set of dedicated funcitonailities, provided as Renku plugins, are made available. Specifically, these plugins aim to achieve the following:</p>
<ul>
<li>Offer a visualization of the project&rsquo;s Knowledge Graph (<code>renku-graph-vis</code> plugin)</li>
<li>Intercept calls to <code>astroquery</code> functions and store them in the project&rsquo;s Knowledge Graph (<code>renku-aqs-annotation</code> plugin)</li>
</ul>
<p>See below how to install these plugins, which are not available by default.</p>
<h4 id="visualizing-project-knowledge-graph-with-renku-graph-vis-plugin">
  Visualizing project Knowledge Graph with <code>renku-graph-vis</code> plugin
  <a class="anchor" href="#visualizing-project-knowledge-graph-with-renku-graph-vis-plugin">#</a>
</h4>
<p>This plugin provides a graphical representation of the renku repository&rsquo;s knowledge graph, possibly from within the renku session.</p>
<p>The plugin provides two CLI commands:</p>
<ul>
<li><code>display</code> to generate a representation of the graph over an output image</li>
<li><code>show-graph</code> to start an interactive visualization of the graph over the browser</li>
</ul>
<p>Furthermore, the plugin provides an interactive graph visualization feature for real-time monitoring during a renku session. To initiate or access the live graph visualization during your session, simply click on the Graph icon located on the main page, as shown in the image below.</p>
<p><img src="renkulab_overview_example_1.png" alt="" /></p>
<p>The primary benefit introduced is the ability to have a live overview of the ongoing development within an interactive Renku session. This can be seen within the animation below, where the graph is automatically updated with information about the execution of a notebook upon its completion.</p>
<p><img src="renkulab_execution_example_3.gif" alt="" /></p>
<p>This visualization also includes the ODA ontology, providing valuable insights into the types of entities within it that are known to the ontology, and therefore helping during the workflow development. The image below displays a graph where the ODA ontology has been imported, and it can be seen that the <code>SimbadClass</code> node is an instance of the <code>AstroqueryModule</code> class, while <code>Mrk 421</code> is an instance of the <code>AstrophysicalObject</code> class.</p>
<p><img src="details_astroquery_annotations_2.png" alt="" /></p>
<p>More technical details are presented in the README of the repo page: <a href="https://github.com/oda-hub/renku-graph-vis/">https://github.com/oda-hub/renku-graph-vis/</a></p>
<h5 id="installation">
  Installation
  <a class="anchor" href="#installation">#</a>
</h5>
<p>The plugin can be installed via pip on your own environment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install renku_graph_vis
</code></pre></div><p>Alternatively, it can be made available within a Renku session by adding it in the list of requirements of the Renku project, within your <code>requirements.txt</code> file.</p>
<h4 id="tracking-access-to-astronomical-archives-and-services-in-the-project-knowledge-graph-by-using-renku-aqs-annotation-plugin">
  Tracking access to astronomical archives and services in the project Knowledge Graph by using <code>renku-aqs-annotation</code> plugin
  <a class="anchor" href="#tracking-access-to-astronomical-archives-and-services-in-the-project-knowledge-graph-by-using-renku-aqs-annotation-plugin">#</a>
</h4>
<p>This plugin intercepts several key <code>astroquery</code> methods and stores annotations containing information about the calls to these methods (like the arguments used in the call) to the project&rsquo;s Knowledge Graph: <a href="https://github.com/oda-hub/renku-aqs-annotation">https://github.com/oda-hub/renku-aqs-annotation</a></p>
<p>In the image below, the information added to the project Knowledge Graph is highlighted. Specifically, it can be seen that during a papermill run of the <code>test-notebook.ipynb</code> notebook (that produced <code>out.ipynb</code> as an output notebook) a call to the astroquery method <code>query_object</code>, via the <code>Simbadclass</code>, has been detected. This notebook is requesting the object <code>Mrk 421</code> object. The hightlighed labels on the edges provide information about the relationship between the two nodes: during the <code>papermill</code> execution, a call to the <code>query_object</code> method is executed (<code>call</code> label) and in turn, this requests the Astrophysical Object <code>Mrk 421</code>.</p>
<p><img src="details_astroquery_annotations_1.png" alt="" /></p>
<h5 id="installation-1">
  Installation
  <a class="anchor" href="#installation-1">#</a>
</h5>
<p>The plugin can be installed either via pip on your own evironment:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-bash" data-lang="bash">pip install renku_aqs_annotation
</code></pre></div><p>Just like the <code>renku_graph_vis</code> plugin, the <code>renku_aqs_annotation</code> plugin can be made available within a Renku session by adding it to the list of requirements in your <code>requirements.txt</code> file for the Renku project.</p>
<h3 id="inform-mmoda-team-and-suggest-automatic-test-cases-to-ensure-service-stability">
  Inform <strong>MMODA</strong> team and suggest automatic test cases to ensure service stability
  <a class="anchor" href="#inform-mmoda-team-and-suggest-automatic-test-cases-to-ensure-service-stability">#</a>
</h3>
<p>Please contact <a href="https://www.astro.unige.ch/mmoda">MMODA</a> team (see contact form) to inform that you have created a new Open Research Data Analysis Service (ORDAS). We will check the functionalities and stability of your service, and we can inform the user community on availability of this new service. We will also ask you to suggest automatic tests of service operations that will be performed from time to time, to  make sure your service does not break with future updates or because of unavailability of external services providing the input data for your analysis workflow. We can also add acknowledgements to the data providers and to you as the workflow developer.</p>
</article>
 
      

      <footer class="book-footer">
        
  <div class="flex flex-wrap justify-between">





</div>



  <script>(function(){function a(c){const a=window.getSelection(),b=document.createRange();b.selectNodeContents(c),a.removeAllRanges(),a.addRange(b)}document.querySelectorAll("pre code").forEach(b=>{b.addEventListener("click",function(c){if(window.getSelection().toString())return;a(b.parentElement),navigator.clipboard&&navigator.clipboard.writeText(b.parentElement.textContent)})})})()</script>


 
        
      </footer>

      
  
  <div class="book-comments">

</div>
  
 

      <label for="menu-control" class="hidden book-menu-overlay"></label>
    </div>

    
    <aside class="book-toc">
      <div class="book-toc-content">
        
  
<nav id="TableOfContents">
  <ul>
    <li><a href="#build-a-repeatable-parameterized-workflow">Build a repeatable parameterized workflow</a>
      <ul>
        <li><a href="#how-to-designate-input-parameters-and-output-cells-of-the-notebook">How to designate input parameters and output cells of the notebook</a></li>
        <li><a href="#how-to-define-input-parameters-in-the-dedicated-parameters-cell">How to define input parameters in the dedicated parameters cell</a></li>
        <li><a href="#default-parameters">Default parameters</a></li>
        <li><a href="#adding-annotations-the-entire-notebook">Adding annotations the entire notebook</a></li>
        <li><a href="#adding-external-resource-annotations">Adding external resource annotations</a></li>
        <li><a href="#adding-token-annotations">Adding token annotations</a></li>
        <li><a href="#how-to-annotate-the-notebook-outputs">How to annotate the notebook outputs</a></li>
        <li><a href="#quering-external-astronomical-data-archives-from-a-notebook">Quering external astronomical data archives from a notebook</a></li>
        <li><a href="#handling-exceptions">Handling exceptions</a></li>
        <li><a href="#how-to-add-a-test-to-the-notebook">How to add a test to the notebook</a></li>
        <li><a href="#reporting-progress-for-long-running-tasks">Reporting progress for long running tasks</a></li>
      </ul>
    </li>
    <li><a href="#make-the-notebook-available-for-deployment-on-mmodahttpswwwastrounigechmmoda-via-renkulabiohttpsrenkulabio">Make the notebook available for deployment on <a href="https://www.astro.unige.ch/mmoda/">MMODA</a> via <a href="https://renkulab.io/">renkulab.io</a></a></li>
    <li><a href="#publish-your-workflow-as-an-mmoda-service">Publish your workflow as an <strong>MMODA</strong> service</a>
      <ul>
        <li><a href="#support-the-workflow-development-via-renku-plugin">Support the workflow development via renku plugin</a></li>
        <li><a href="#inform-mmoda-team-and-suggest-automatic-test-cases-to-ensure-service-stability">Inform <strong>MMODA</strong> team and suggest automatic test cases to ensure service stability</a></li>
      </ul>
    </li>
  </ul>
</nav>


 
      </div>
    </aside>
    
  </main>

  
</body>
</html>












